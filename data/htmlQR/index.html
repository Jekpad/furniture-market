<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="qrcode.js">
	</script>
    <script type="text/javascript" src="html5-qrcode.js">
	</script>
    <script type="text/javascript" src="Utf8.js">
	</script>
    <script type="text/javascript" src="QRCapacity.js">
	</script>
	<script type="text/javascript">
		if(addon)//available as experimental feature for trusted panel source files in jetpack sdk
		{
			addon.port.on("myAddonScriptEvent", function(payloadFromAddon)
			{
				if(payloadFromAddon["event"]=="showQR")
				{
					updateQRCode(payloadFromAddon["text"], payloadFromAddon["errorCorrectLevel"], payloadFromAddon["blockSize"]);
				}
			});
		}
		
		function dispatchRequiredPanelSize(size)
		{
			if(addon)
			{
				addon.port.emit("resizePanel", {"size": size});
			}
		}
		
		var pendingPayloadFromAddon;
		function updateQRCode(text, errorCorrectLevel, blockSize)
		{
			text = Utf8.encode(text);
			
			var reqVersion = -1;
			try
			{
				reqVersion = getMinQRVersion(text.length, errorCorrectLevel);
			}
			catch(err)
			{
				console.error(err);
				return;
			}			
	
			var modCount = getModuleCountForVersion(reqVersion);
			
			var canvasSize = Math.min(400, (modCount+8)*blockSize);
			
			var element = document.getElementById("qrcode");

			if(element)
			{
				dispatchRequiredPanelSize(canvasSize);

				if(element.lastChild)
				  element.replaceChild(showQRCode(text, reqVersion, errorCorrectLevel, canvasSize), element.lastChild);
				else
				  element.appendChild(showQRCode(text, reqVersion, errorCorrectLevel, canvasSize));
				  
				 element.style.width = "100%";
				 element.style.height = "100%";
			}
			else
			{
				pendingPayloadFromAddon = {"text": text, "errorCorrectLevel": errorCorrectLevel, "blockSize": blockSize};
			}
		}
		function onLoad()
		{
			if(pendingPayloadFromAddon)
			{
				updateQRCode(pendingPayloadFromAddon["text"],
							pendingPayloadFromAddon["errorCorrectLevel"],
							pendingPayloadFromAddon["blockSize"]
							);
				pendingPayloadFromAddon = undefined;
			}
		}
	</script>
  </head>
  <body onload="onLoad()" style="margin:0px;">
  <!-- This is where our QRCode will appear in. -->
    <div id="qrcode" style="line-height:0"></div>
  </body>
</html>