<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="qrcode.js">
	</script>
    <script type="text/javascript" src="html5-qrcode.js">
	</script>
    <script type="text/javascript" src="Utf8.js">
	</script>
    <script type="text/javascript" src="QRCapacity.js">
	</script>
    <script type="text/javascript" src="FileSaver.min.js">
	</script>
	<script type="text/javascript">
		var QueryString = function () {
			var query_string = {};
			var query = document.location.search.substring(1);
			var vars = query.split("&");
			for (var i=0;i<vars.length;i++)
			{
				var pair = vars[i].split("=");
				query_string[pair[0]] = pair[1];
			} 
			return query_string;
		} ();
		var isRunningInAddon = QueryString["isAddon"];
	
		if(isRunningInAddon && addon)//available as experimental feature for trusted panel source files in jetpack sdk
		{
			addon.port.on("myAddonScriptEvent", function(payloadFromAddon)
			{
				if(payloadFromAddon["event"]=="showQR")
				{
					updateQRCode(payloadFromAddon["text"], payloadFromAddon["errorCorrectLevel"], payloadFromAddon["blockSize"]);
				}
			});
		}
		
		function dispatchRequiredPanelSize(canvasSize)
		{
			if(isRunningInAddon && addon)
			{
				var height = canvasSize + 45 /*icon area*/ + 55 /*text area*/
				var width = Math.max(200, canvasSize);

				addon.port.emit("resizePanel", {"height": height, "width": width});
			}
		}
		
		var pendingPayload;
		function updateQRCode(text, errorCorrectLevel, blockSize)
		{
			updateTextAreaText(text);
			text = Utf8.encode(text);
			
			var reqVersion = -1;
			try
			{
				reqVersion = getMinQRVersion(text.length, errorCorrectLevel);
			}
			catch(err)
			{
				console.error(err);
				return;
			}			
	
			var modCount = getModuleCountForVersion(reqVersion);
			
			var canvasSize = Math.min(400, (modCount+8)*blockSize);
			
			var element = document.getElementById("qrcode");

			if(element)
			{
				if(element.lastChild)
				  element.replaceChild(showQRCode(text, reqVersion, errorCorrectLevel, canvasSize), element.lastChild);
				else
				  element.appendChild(showQRCode(text, reqVersion, errorCorrectLevel, canvasSize));
				  
				element.style.width = (canvasSize + "px");

				dispatchRequiredPanelSize(canvasSize);
			 }
			else
			{
				pendingPayload = {"text": text, "errorCorrectLevel": errorCorrectLevel, "blockSize": blockSize};
			}
		}
		function onLoad()
		{
			var textElement = document.getElementById("text");
			if(textElement)
			{
				textElement.style.resize = (isRunningInAddon?"none":"both");
				
				if(QueryString["loadText"])
				{
					textElement.value = decodeURIComponent(decodeURIComponent(QueryString["loadText"]));
					updateQRCodeWithTA();
				}
			}
			
			var openElement = document.getElementById("openLink");
			if(openElement)
			{
				openElement.style.display = (isRunningInAddon?"block":"none");
			}

			if(pendingPayload)
			{
				updateQRCode(pendingPayload["text"],
							pendingPayload["errorCorrectLevel"],
							pendingPayload["blockSize"]
							);
				pendingPayload = undefined;
			}
		}
		
		function updateTextAreaText(text)
		{
			var textArea = document.getElementById("text");
			if(textArea)
			{
				var textAreaText = textArea.value;
				if(textAreaText!=text)
				{
					textArea.value = text;
				}
			}
		}
		
		function handleSaveClick()
		{
			var element = document.getElementById("qrcode");
			if(element)
			{
				if(element.lastChild)
				{
					var canvas = element.lastChild;
					canvas.toBlob(function(blob) {
						saveAs(blob, "QR.png");
					});
				}
			}
		}
		
		function handleOpenClick()
		{
			var textArea = document.getElementById("text");
			if(textArea && addon)
			{
				addon.port.emit("openNew", {"text": encodeURIComponent(encodeURIComponent(textArea.value))});
			}
		}
		
		function updateQRCodeWithTA()
		{
			var textArea = document.getElementById("text");
			if(textArea)
			{
				var qrLevel = QueryString["errorCorrectLevel"];
				if(qrLevel==undefined)qrLevel = "L";
				var blockSize = QueryString["blockSize"];
				if(blockSize==undefined)blockSize = 3;

				updateQRCode(textArea.value, qrLevel, blockSize);
			}
		}
		
		var taChangeTimer;
		function handleTAChange()
		{
			if(taChangeTimer)
			{
				clearInterval(taChangeTimer);
			}
			taChangeTimer = setInterval(function(){updateQRCodeWithTA()}, 200);
		}
	</script>
  </head>
  <body id="doc" onload="onLoad()" style="margin:0px;">
	<!-- This is where our QRCode will appear in. -->
    <div id="qrcode" style="line-height:0;margin-left:auto;margin-right:auto"></div>
	<br/>
	<a id="saveLink" href="javascript:void(0);" onclick="handleSaveClick()"><img src="assets/grey_save.png" alt="Save"/></a>
	<a id="openLink" href="javascript:void(0);" onclick="handleOpenClick()" style="float:right"><img src="assets/open_new.png" alt="Open"/></a>
	<br/>
	<textarea id="text" onkeyup="handleTAChange()" style="resize:none;height:100%;width:100%;-moz-box-sizing:border-box;box-sizing:border-box"></textarea>
  </body>
</html>